name: PR Benchmark Compare

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:
    inputs:
      base_repo:
        description: 'Base repository to compare against'
        required: false
        default: 'auto-differentiation/xad'
        type: choice
        options:
          - 'auto-differentiation/xad'
          - 'da-roth/xad-jit'
      base_ref:
        description: 'Base branch/ref to compare against'
        required: false
        default: 'main'

env:
  # Default to original XAD repo for comparison
  BASE_REPO: ${{ github.event.inputs.base_repo || 'auto-differentiation/xad' }}
  BASE_REF: ${{ github.event.inputs.base_ref || 'main' }}

jobs:
  benchmark:
    name: Compare Benchmarks
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foonathan/gcc:12
    steps:
      - name: Hardware characteristics
        run: |
          echo "----------------- CPU ----------------"
          lscpu
          echo "------------------ Mem ---------------"
          lsmem

      # Checkout base branch (original XAD by default) for reference build
      - name: Checkout base branch
        uses: actions/checkout@v6
        with:
          repository: ${{ env.BASE_REPO }}
          ref: ${{ env.BASE_REF }}
          path: base

      # Checkout PR branch for comparison build
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          path: pr

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: benchmark-pr-compare

      # Build base branch (reference)
      - name: Configure base branch
        run: |
          cd base
          mkdir build
          cd build
          cmake .. -GNinja \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++ \
            -DXAD_NO_THREADLOCAL=ON \
            -DXAD_SIMD_OPTION=AVX2 \
            -DXAD_USE_STRONG_INLINE=ON

      - name: Build base branch
        run: |
          cd base/build
          cmake --build .

      # Build PR branch
      - name: Configure PR branch
        run: |
          cd pr
          mkdir build
          cd build
          cmake .. -GNinja \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++ \
            -DXAD_NO_THREADLOCAL=ON \
            -DXAD_SIMD_OPTION=AVX2 \
            -DXAD_USE_STRONG_INLINE=ON

      - name: Build PR branch
        run: |
          cd pr/build
          cmake --build .

      # Run tests on PR branch to make sure it works
      - name: Run Tests (PR branch)
        run: |
          cd pr/build
          ctest --no-compress-output --output-on-failure --parallel $(($(nproc) + 2))

      # Run benchmarks
      - name: Run Base Benchmark
        run: |
          set -e
          cd base/build/samples/LiborSwaptionPricer
          # warmup run
          ./LiborSwaptionPricer 50000
          rm -f benchmark.log || true
          for i in $(seq 1 5) ; do \
            ./LiborSwaptionPricer 50000 | tee -a benchmark.log ; \
          done

      - name: Run PR Benchmark
        run: |
          set -e
          cd pr/build/samples/LiborSwaptionPricer
          # warmup run
          ./LiborSwaptionPricer 50000
          rm -f benchmark.log || true
          for i in $(seq 1 5) ; do \
            ./LiborSwaptionPricer 50000 | tee -a benchmark.log ; \
          done

      - name: Compare Results
        id: compare
        run: |
          set -e
          apt-get update && apt-get install -y bc datamash

          echo "## Benchmark Results" > results.md
          echo "" >> results.md
          echo "Comparing base (\`${{ env.BASE_REPO }}@${{ env.BASE_REF }}\`) vs PR branch (\`${{ github.event.pull_request.head.ref || github.ref_name }}\`)" >> results.md
          echo "" >> results.md

          echo "### Raw Statistics (5 runs each)" >> results.md
          echo "" >> results.md
          echo "| Branch | Min | Max | Mean | StdDev | Median |" >> results.md
          echo "|--------|-----|-----|------|--------|--------|" >> results.md

          echo "**Base branch:**"
          BASE_STATS=$(awk '$2 == "AAD" { print $4 }' base/build/samples/LiborSwaptionPricer/benchmark.log | datamash min 1 max 1 mean 1 sstdev 1 median 1)
          BASE_TIME=$(echo "$BASE_STATS" | awk '{print $5}')
          echo "| Base | $(echo "$BASE_STATS" | awk '{printf "%.3fs | %.3fs | %.3fs | %.3fs | %.3fs", $1, $2, $3, $4, $5}') |" >> results.md

          echo "**PR branch:**"
          PR_STATS=$(awk '$2 == "AAD" { print $4 }' pr/build/samples/LiborSwaptionPricer/benchmark.log | datamash min 1 max 1 mean 1 sstdev 1 median 1)
          PR_TIME=$(echo "$PR_STATS" | awk '{print $5}')
          echo "| PR | $(echo "$PR_STATS" | awk '{printf "%.3fs | %.3fs | %.3fs | %.3fs | %.3fs", $1, $2, $3, $4, $5}') |" >> results.md

          echo "" >> results.md
          echo "### Summary" >> results.md
          echo "" >> results.md

          DIFFERENCE=$(echo "scale=6; $BASE_TIME - $PR_TIME" | bc | awk '{printf "%.3f", $1}')
          PERCENTAGE=$(echo "scale=6; (($BASE_TIME - $PR_TIME) / $BASE_TIME) * 100.0" | bc | awk '{printf "%.2f", $1}')

          echo "| Metric | Value |" >> results.md
          echo "|--------|-------|" >> results.md
          echo "| Base median | ${BASE_TIME}s |" >> results.md
          echo "| PR median | ${PR_TIME}s |" >> results.md
          echo "| Difference | ${DIFFERENCE}s |" >> results.md
          echo "| Change | ${PERCENTAGE}% |" >> results.md
          echo "" >> results.md

          # Determine if improvement or regression
          if (( $(echo "$PERCENTAGE > 1" | bc -l) )); then
            echo "> **Improvement**: PR is ${PERCENTAGE}% faster than base" >> results.md
          elif (( $(echo "$PERCENTAGE < -1" | bc -l) )); then
            echo "> **Regression**: PR is $(echo "$PERCENTAGE * -1" | bc)% slower than base" >> results.md
          else
            echo "> **No significant change**: Within 1% margin" >> results.md
          fi

          cat results.md

      - name: Upload Results
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-results
          path: results.md

      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: results.md
          edit-mode: replace
