name: Benchmarks
on: [push, pull_request]
  #pull_request:
    # types: [opened, reopened, synchronize, labeled, unlabeled ]


jobs:
  benchmark:
    # if: contains(github.event.pull_request.labels.*.name, 'benchmarks') || github.event_name == 'workflow_dispatch'
    name: Benchmark
    runs-on: ubuntu-latest
    container: 
      image: ghcr.io/foonathan/gcc:12
    steps:
      - name: Hardware characteristics
        run: |
          echo "----------------- CPU ----------------"
          lscpu
          echo "------------------ Mem ---------------"
          lsmem
      - uses: actions/checkout@v4
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: benchmark
      - name: configure
        run: |
          mkdir build
          cd build
          cmake .. -GNinja \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++ \
            -DXAD_NO_THREADLOCAL=ON \
            -DXAD_SIMD_OPTION=AVX2 \
            -DXAD_USE_STRONG_INLINE=ON          
      - name: build
        run: |
          cd build
          cmake --build .
      # main branch: run reference benchmark and upload artifact
      - name: Run Reference
        if: ${{ github.ref == 'refs/heads/main' }}
        run: |
          chmod +x ./scripts/benchmark.sh
          ./scripts/benchmark.sh reference 1 Hessian Jacobian
      - name: Push Reference
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: actions/upload-artifact@v4
        with:
          name: reference
          path: /__w/xad/xad/build/benchmarks/reference.json
          if-no-files-found: error
          retention-days: 90
          overwrite: true
      # pr: pull reference artifact then run benchmark
      - name: Pull Reference
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/download-artifact@v4
        with:
          path: /__w/xad/xad/build/benchmarks
      - name: Run Benchmark
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          chmod +x ./scripts/benchmark.sh
          ./scripts/benchmark.sh benchmark 1 Hessian Jacobian
      - name: Upload Benchmark Results
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: /__w/xad/xad/build/benchmarksbenchmark_results.md
      
  update-runid:
    name: Update Run-id
    runs-on: ubuntu-latest
    # if: github.event_name == 'workflow_dispatch'
    needs:
      - benchmark
    steps:
      - uses: actions/checkout@v4
      - name: Set runid variable
        run: |
          gh variable list
          gh variable set REFERENCE_RUN_ID --body "${{ github.run_id }}"
          gh variable list
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_READ_TOKEN }}


  collect:
    name: Collect Results
    runs-on: ubuntu-latest
# if: github.event_name == 'pull_request'
    needs:
      - benchmark
    steps:
      - name: Find Comment
        uses: peter-evans/find-comment@v3
        if: github.event_name == 'pull_request'
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: Performance Results
      - name: Download Benchmark Results
        uses: actions/download-artifact@v2
        with:
          name: benchmark-results
          path: .
      - name: Rename Benchmark Results
        run: mv benchmark_results.md results.md
      - name: Post or update PR comment
        id: pr-comment
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: results.md
          edit-mode: replace
