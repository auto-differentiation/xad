##############################################################################
#
#  Benchmarks JIT Backends
#
#  Compares different JIT configurations for LiborSwaptionPricer:
#  - JIT=OFF:              FD + XAD tape-based AAD (baseline)
#  - JIT=ON:               FD + XAD with built-in JIT enabled
#  - JIT=ON, ForgeBackend: FD + XAD + Forge JIT + JIT-AVX
#
#  Dependencies (ForgeBackend only):
#  - xad-forge (da-roth/xad-forge)
#  - Forge C API (da-roth/forge)
#
#  Copyright (C) 2010-2025 Xcelerit Computing Ltd.
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: Benchmarks JIT Backends

on:
  push:
    paths:
      - 'samples/LiborSwaptionPricer/**'
      - '.github/workflows/benchmark-libor.yml'
  pull_request:
    paths:
      - 'samples/LiborSwaptionPricer/**'
      - '.github/workflows/benchmark-libor.yml'
  workflow_dispatch:
    inputs:
      jit_mode:
        description: 'JIT Mode'
        required: true
        default: 'all'
        type: choice
        options:
          - 'off'
          - 'on'
          - 'forge'
          - 'all'
      forge_repo:
        description: 'Forge repository'
        required: false
        default: 'da-roth/forge'
      forge_branch:
        description: 'Forge branch'
        required: false
        default: 'main'
      xad_forge_repo:
        description: 'xad-forge repository'
        required: false
        default: 'da-roth/xad-forge'
      xad_forge_branch:
        description: 'xad-forge branch'
        required: false
        default: 'main'

env:
  FORGE_REPO: ${{ github.event.inputs.forge_repo || 'da-roth/forge' }}
  FORGE_BRANCH: ${{ github.event.inputs.forge_branch || 'main' }}
  XAD_FORGE_REPO: ${{ github.event.inputs.xad_forge_repo || 'da-roth/xad-forge' }}
  XAD_FORGE_BRANCH: ${{ github.event.inputs.xad_forge_branch || 'main' }}

jobs:
  ##############################################################################
  # Linux Benchmarks
  ##############################################################################
  linux:
    name: Linux, JIT=${{ matrix.jit }}${{ matrix.jit == 'on' && ', ForgeBackend' || '' }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foonathan/gcc:13

    strategy:
      fail-fast: false
      matrix:
        jit:
          - 'off'
          - 'on'
        include:
          - jit: 'off'
            xad_jit: 'OFF'
            forge: false
            target: 'LiborSwaptionPricerBenchmark'
          - jit: 'on'
            xad_jit: 'ON'
            forge: true
            target: 'LiborSwaptionPricerJIT'
        exclude:
          - jit: ${{ github.event.inputs.jit_mode == 'off' && 'on' || '' }}
          - jit: ${{ github.event.inputs.jit_mode == 'on' && 'off' || '' }}
          - jit: ${{ github.event.inputs.jit_mode == 'forge' && 'off' || '' }}

    steps:
      - name: Hardware Info
        run: |
          echo "===== CPU ====="
          lscpu | grep -E "^(Model name|CPU\(s\)|Thread|Core|Socket|CPU max MHz)"
          echo "===== Memory ====="
          free -h

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          path: xad

      - name: Checkout Forge
        if: matrix.forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORGE_REPO }}
          ref: ${{ env.FORGE_BRANCH }}
          path: forge

      - name: Checkout xad-forge
        if: matrix.forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_FORGE_REPO }}
          ref: ${{ env.XAD_FORGE_BRANCH }}
          path: xad-forge

      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build cmake

      # --- ForgeBackend build steps ---
      - name: Build Forge C API
        if: matrix.forge
        run: |
          cd forge
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DFORGE_CAPI_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Build XAD
        run: |
          cd xad
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DXAD_ENABLE_JIT=${{ matrix.xad_jit }} \
            -DXAD_ENABLE_TESTS=ON \
            -DXAD_SIMD_OPTION=AVX2 \
            -DXAD_NO_THREADLOCAL=ON \
            -DXAD_USE_STRONG_INLINE=ON \
            ${{ matrix.forge && '-DCMAKE_PREFIX_PATH=$(pwd)/../install -DCMAKE_INSTALL_PREFIX=$(pwd)/../install' || '' }}
          cmake --build build --target xad
          ${{ matrix.forge && 'cmake --install build' || '' }}

      - name: Build xad-forge
        if: matrix.forge
        run: |
          cd xad-forge
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DXAD_FORGE_USE_CAPI=ON \
            -DXAD_FORGE_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Build Benchmark Target (ForgeBackend)
        if: matrix.forge
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad
          cmake -B build-benchmark -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DXAD_ENABLE_JIT=ON \
            -DXAD_ENABLE_TESTS=ON \
            -DXAD_SIMD_OPTION=AVX2 \
            -DXAD_NO_THREADLOCAL=ON \
            -DXAD_USE_STRONG_INLINE=ON \
            -DCMAKE_PREFIX_PATH=$INSTALL_DIR
          cmake --build build-benchmark --target ${{ matrix.target }}

      - name: Build Benchmark Target (No Forge)
        if: ${{ !matrix.forge }}
        run: |
          cd xad
          cmake --build build --target ${{ matrix.target }}

      # --- Run benchmarks ---
      - name: Run Benchmark (ForgeBackend)
        if: matrix.forge
        run: |
          export LD_LIBRARY_PATH=$(pwd)/install/lib:$LD_LIBRARY_PATH
          ./xad/build-benchmark/samples/LiborSwaptionPricer/JIT/${{ matrix.target }}

      - name: Run Benchmark (No Forge)
        if: ${{ !matrix.forge }}
        run: |
          ./xad/build/samples/LiborSwaptionPricer/${{ matrix.target }}

  ##############################################################################
  # Windows Benchmarks
  ##############################################################################
  windows:
    name: Windows, JIT=${{ matrix.jit }}${{ matrix.jit == 'on' && ', ForgeBackend' || '' }}
    runs-on: windows-2022

    strategy:
      fail-fast: false
      matrix:
        jit:
          - 'off'
          - 'on'
        include:
          - jit: 'off'
            xad_jit: 'OFF'
            forge: false
            target: 'LiborSwaptionPricerBenchmark'
          - jit: 'on'
            xad_jit: 'ON'
            forge: true
            target: 'LiborSwaptionPricerJIT'
        exclude:
          - jit: ${{ github.event.inputs.jit_mode == 'off' && 'on' || '' }}
          - jit: ${{ github.event.inputs.jit_mode == 'on' && 'off' || '' }}
          - jit: ${{ github.event.inputs.jit_mode == 'forge' && 'off' || '' }}

    env:
      VSVARSALL: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat

    steps:
      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          path: xad

      - name: Checkout Forge
        if: matrix.forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORGE_REPO }}
          ref: ${{ env.FORGE_BRANCH }}
          path: forge

      - name: Checkout xad-forge
        if: matrix.forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_FORGE_REPO }}
          ref: ${{ env.XAD_FORGE_BRANCH }}
          path: xad-forge

      - name: Setup
        run: choco install -y ninja

      # --- ForgeBackend build steps ---
      - name: Build Forge C API
        if: matrix.forge
        shell: cmd
        run: |
          cd forge
          call "%VSVARSALL%" amd64
          cmake -B build -S api/c -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DFORGE_CAPI_BUILD_TESTS=OFF ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build
          cmake --install build

      - name: Build XAD
        shell: cmd
        run: |
          cd xad
          call "%VSVARSALL%" amd64
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_STANDARD=17 ^
            -DXAD_ENABLE_JIT=${{ matrix.xad_jit }} ^
            -DXAD_ENABLE_TESTS=ON ^
            -DXAD_SIMD_OPTION=AVX2 ^
            -DXAD_NO_THREADLOCAL=ON ^
            -DXAD_USE_STRONG_INLINE=ON ^
            ${{ matrix.forge && '-DCMAKE_PREFIX_PATH="%cd%\..\install" -DCMAKE_INSTALL_PREFIX="%cd%\..\install"' || '' }}
          cmake --build build --target xad
          ${{ matrix.forge && 'cmake --install build' || '' }}

      - name: Build xad-forge
        if: matrix.forge
        shell: cmd
        run: |
          cd xad-forge
          call "%VSVARSALL%" amd64
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_STANDARD=17 ^
            -DCMAKE_PREFIX_PATH="%cd%\..\install" ^
            -DXAD_FORGE_USE_CAPI=ON ^
            -DXAD_FORGE_BUILD_TESTS=OFF ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build
          cmake --install build

      - name: Build Benchmark Target (ForgeBackend)
        if: matrix.forge
        shell: cmd
        run: |
          set INSTALL_DIR=%cd%\install
          cd xad
          call "%VSVARSALL%" amd64
          cmake -B build-benchmark -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_STANDARD=17 ^
            -DXAD_ENABLE_JIT=ON ^
            -DXAD_ENABLE_TESTS=ON ^
            -DXAD_SIMD_OPTION=AVX2 ^
            -DXAD_NO_THREADLOCAL=ON ^
            -DXAD_USE_STRONG_INLINE=ON ^
            -DCMAKE_PREFIX_PATH="%INSTALL_DIR%"
          cmake --build build-benchmark --target ${{ matrix.target }}

      - name: Build Benchmark Target (No Forge)
        if: ${{ !matrix.forge }}
        shell: cmd
        run: |
          cd xad
          call "%VSVARSALL%" amd64
          cmake --build build --target ${{ matrix.target }}

      # --- Run benchmarks ---
      - name: Run Benchmark (ForgeBackend)
        if: matrix.forge
        shell: cmd
        run: |
          set PATH=%cd%\install\bin;%PATH%
          xad\build-benchmark\samples\LiborSwaptionPricer\JIT\${{ matrix.target }}.exe

      - name: Run Benchmark (No Forge)
        if: ${{ !matrix.forge }}
        shell: cmd
        run: |
          xad\build\samples\LiborSwaptionPricer\${{ matrix.target }}.exe

  ##############################################################################
  # Performance Decomposition - Detailed timing breakdown
  ##############################################################################
  decomposition:
    name: Performance Decomposition (Linux)
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foonathan/gcc:13
    if: github.event.inputs.jit_mode != 'off'

    steps:
      - name: Hardware Info
        run: |
          echo "===== CPU ====="
          lscpu | grep -E "^(Model name|CPU\(s\)|Thread|Core|Socket|CPU max MHz)"
          echo "===== Memory ====="
          free -h

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          path: xad

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORGE_REPO }}
          ref: ${{ env.FORGE_BRANCH }}
          path: forge

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_FORGE_REPO }}
          ref: ${{ env.XAD_FORGE_BRANCH }}
          path: xad-forge

      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build cmake

      - name: Build Forge C API
        run: |
          cd forge
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DFORGE_CAPI_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Build XAD
        run: |
          cd xad
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DXAD_ENABLE_JIT=ON \
            -DXAD_ENABLE_TESTS=ON \
            -DXAD_SIMD_OPTION=AVX2 \
            -DXAD_NO_THREADLOCAL=ON \
            -DXAD_USE_STRONG_INLINE=ON \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build --target xad
          cmake --install build

      - name: Build xad-forge
        run: |
          cd xad-forge
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DXAD_FORGE_USE_CAPI=ON \
            -DXAD_FORGE_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Build Benchmark
        run: |
          INSTALL_DIR=$(pwd)/install
          cd xad
          cmake -B build-benchmark -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DXAD_ENABLE_JIT=ON \
            -DXAD_ENABLE_TESTS=ON \
            -DXAD_SIMD_OPTION=AVX2 \
            -DXAD_NO_THREADLOCAL=ON \
            -DXAD_USE_STRONG_INLINE=ON \
            -DCMAKE_PREFIX_PATH=$INSTALL_DIR
          cmake --build build-benchmark --target LiborSwaptionPricerJIT

      - name: Run Performance Decomposition
        run: |
          export LD_LIBRARY_PATH=$(pwd)/install/lib:$LD_LIBRARY_PATH
          ./xad/build-benchmark/samples/LiborSwaptionPricer/JIT/LiborSwaptionPricerJIT --decomposition

  ##############################################################################
  # Compare JIT Build Impact - Original XAD test
  ##############################################################################
  compare-jit:
    name: Compare JIT Build Impact
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foonathan/gcc:12

    steps:
      - name: Hardware characteristics
        run: |
          echo "----------------- CPU ----------------"
          lscpu
          echo "------------------ Mem ---------------"
          lsmem

      - name: Checkout
        uses: actions/checkout@v4

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: benchmark-jit-on-off

      # Build JIT disabled (reference)
      - name: Configure (JIT OFF)
        run: |
          mkdir -p build-off
          cd build-off
          cmake .. -GNinja \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++ \
            -DXAD_NO_THREADLOCAL=ON \
            -DXAD_SIMD_OPTION=AVX2 \
            -DXAD_USE_STRONG_INLINE=ON \
            -DXAD_ENABLE_JIT=OFF

      - name: Build (JIT OFF)
        run: |
          cd build-off
          cmake --build .

      # Build JIT enabled
      - name: Configure (JIT ON)
        run: |
          mkdir -p build-on
          cd build-on
          cmake .. -GNinja \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++ \
            -DXAD_NO_THREADLOCAL=ON \
            -DXAD_SIMD_OPTION=AVX2 \
            -DXAD_USE_STRONG_INLINE=ON \
            -DXAD_ENABLE_JIT=ON

      - name: Build (JIT ON)
        run: |
          cd build-on
          cmake --build .

      # Run tests on JIT-enabled build
      - name: Run Tests (JIT ON)
        run: |
          cd build-on
          ctest --no-compress-output --output-on-failure --parallel $(($(nproc) + 2))

      # Run benchmarks
      - name: Run Benchmark (JIT OFF)
        run: |
          set -e
          cd build-off/samples/LiborSwaptionPricer
          # warmup run
          ./LiborSwaptionPricer 50000
          rm -f benchmark_off.log || true
          for i in $(seq 1 5) ; do \
            ./LiborSwaptionPricer 50000 | tee -a benchmark_off.log ; \
          done

      - name: Run Benchmark (JIT ON)
        run: |
          set -e
          cd build-on/samples/LiborSwaptionPricer
          # warmup run
          ./LiborSwaptionPricer 50000
          rm -f benchmark_on.log || true
          for i in $(seq 1 5) ; do \
            ./LiborSwaptionPricer 50000 | tee -a benchmark_on.log ; \
          done

      - name: Compare Results
        id: compare
        run: |
          set -e
          apt-get update && apt-get install -y bc datamash

          echo "## Benchmark Results: JIT OFF vs ON" > benchmark_results.md
          echo "" >> benchmark_results.md
          echo "Comparing XAD built with \`XAD_ENABLE_JIT=OFF\` vs \`XAD_ENABLE_JIT=ON\`." >> benchmark_results.md
          echo "" >> benchmark_results.md
          echo "- Commit: \`${{ github.sha }}\`" >> benchmark_results.md
          echo "- Paths: 50000" >> benchmark_results.md
          echo "- Runs: 5 (after warmup)" >> benchmark_results.md
          echo "" >> benchmark_results.md

          echo "### Raw Statistics" >> benchmark_results.md
          echo "" >> benchmark_results.md
          echo "| Build | Min | Max | Mean | StdDev | Median |" >> benchmark_results.md
          echo "|-------|-----|-----|------|--------|--------|" >> benchmark_results.md

          echo "**JIT OFF:**"
          OFF_STATS=$(awk '$2 == "AAD" { print $4 }' build-off/samples/LiborSwaptionPricer/benchmark_off.log | datamash min 1 max 1 mean 1 sstdev 1 median 1)
          OFF_TIME=$(echo "$OFF_STATS" | awk '{print $5}')
          echo "| JIT OFF | $(echo "$OFF_STATS" | awk '{printf "%.3fs | %.3fs | %.3fs | %.3fs | %.3fs", $1, $2, $3, $4, $5}') |" >> benchmark_results.md

          echo "**JIT ON:**"
          ON_STATS=$(awk '$2 == "AAD" { print $4 }' build-on/samples/LiborSwaptionPricer/benchmark_on.log | datamash min 1 max 1 mean 1 sstdev 1 median 1)
          ON_TIME=$(echo "$ON_STATS" | awk '{print $5}')
          echo "| JIT ON | $(echo "$ON_STATS" | awk '{printf "%.3fs | %.3fs | %.3fs | %.3fs | %.3fs", $1, $2, $3, $4, $5}') |" >> benchmark_results.md

          echo "" >> benchmark_results.md
          echo "### Summary" >> benchmark_results.md
          echo "" >> benchmark_results.md

          DIFFERENCE=$(echo "scale=6; $OFF_TIME - $ON_TIME" | bc | awk '{printf "%.3f", $1}')
          PERCENTAGE=$(echo "scale=6; (($OFF_TIME - $ON_TIME) / $OFF_TIME) * 100.0" | bc | awk '{printf "%.2f", $1}')

          echo "| Metric | Value |" >> benchmark_results.md
          echo "|--------|-------|" >> benchmark_results.md
          echo "| JIT OFF median | ${OFF_TIME}s |" >> benchmark_results.md
          echo "| JIT ON median | ${ON_TIME}s |" >> benchmark_results.md
          echo "| Difference | ${DIFFERENCE}s |" >> benchmark_results.md
          echo "| Change | ${PERCENTAGE}% |" >> benchmark_results.md
          echo "" >> benchmark_results.md

          if (( $(echo "$PERCENTAGE > 1" | bc -l) )); then
            echo "> **Improvement**: JIT ON is ${PERCENTAGE}% faster than JIT OFF" >> benchmark_results.md
          elif (( $(echo "$PERCENTAGE < -1" | bc -l) )); then
            echo "> **Regression**: JIT ON is $(echo "$PERCENTAGE * -1" | bc)% slower than JIT OFF" >> benchmark_results.md
          else
            echo "> **No significant change**: Within 1% margin" >> benchmark_results.md
          fi

          cat benchmark_results.md

      - name: Upload Results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-jit-compare
          path: benchmark_results.md
