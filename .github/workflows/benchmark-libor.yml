##############################################################################
#
#  LiborSwaptionPricer Benchmark
#
#  Runs the LiborSwaptionPricer sample comparing:
#  - Baseline: FD + XAD tape-based AAD (LiborSwaptionPricer target)
#  - Forge: FD + XAD + JIT + JIT-AVX (LiborSwaptionPricerJIT target)
#
#  Dependencies (Forge build only):
#  - xad-forge (da-roth/xad-forge)
#  - Forge C API (da-roth/forge)
#
#  Copyright (C) 2010-2025 Xcelerit Computing Ltd.
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: Benchmark Libor

on:
  push:
    paths:
      - 'samples/LiborSwaptionPricer/**'
      - '.github/workflows/benchmark-libor.yml'
  pull_request:
    paths:
      - 'samples/LiborSwaptionPricer/**'
      - '.github/workflows/benchmark-libor.yml'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'both'
        type: choice
        options:
          - baseline
          - forge
          - both
      forge_repo:
        description: 'Forge repository'
        required: false
        default: 'da-roth/forge'
      forge_branch:
        description: 'Forge branch'
        required: false
        default: 'main'
      xad_forge_repo:
        description: 'xad-forge repository'
        required: false
        default: 'da-roth/xad-forge'
      xad_forge_branch:
        description: 'xad-forge branch'
        required: false
        default: 'main'

env:
  FORGE_REPO: ${{ github.event.inputs.forge_repo || 'da-roth/forge' }}
  FORGE_BRANCH: ${{ github.event.inputs.forge_branch || 'main' }}
  XAD_FORGE_REPO: ${{ github.event.inputs.xad_forge_repo || 'da-roth/xad-forge' }}
  XAD_FORGE_BRANCH: ${{ github.event.inputs.xad_forge_branch || 'main' }}

jobs:
  ##############################################################################
  # Linux Benchmark
  ##############################################################################
  linux:
    name: Linux ${{ matrix.build_type }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/foonathan/gcc:13

    strategy:
      fail-fast: false
      matrix:
        build_type:
          - baseline
          - forge
        exclude:
          - build_type: ${{ github.event.inputs.build_type == 'baseline' && 'forge' || '' }}
          - build_type: ${{ github.event.inputs.build_type == 'forge' && 'baseline' || '' }}

    steps:
      - name: Hardware Info
        run: |
          echo "===== CPU ====="
          lscpu | grep -E "^(Model name|CPU\(s\)|Thread|Core|Socket|CPU max MHz)"
          echo "===== Memory ====="
          free -h

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          path: xad

      - name: Checkout Forge
        if: matrix.build_type == 'forge'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORGE_REPO }}
          ref: ${{ env.FORGE_BRANCH }}
          path: forge

      - name: Checkout xad-forge
        if: matrix.build_type == 'forge'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_FORGE_REPO }}
          ref: ${{ env.XAD_FORGE_BRANCH }}
          path: xad-forge

      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build cmake

      # --- Forge build steps (only for forge build_type) ---
      - name: Build Forge C API
        if: matrix.build_type == 'forge'
        run: |
          cd forge
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DFORGE_CAPI_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Build XAD (with JIT)
        if: matrix.build_type == 'forge'
        run: |
          cd xad
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DXAD_ENABLE_JIT=ON \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Build xad-forge
        if: matrix.build_type == 'forge'
        run: |
          cd xad-forge
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DXAD_FORGE_USE_CAPI=ON \
            -DXAD_FORGE_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Build LiborSwaptionPricerJIT (Forge)
        if: matrix.build_type == 'forge'
        run: |
          cd xad
          cmake -B build-benchmark -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DXAD_ENABLE_JIT=ON \
            -DXAD_ENABLE_TESTS=ON \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install
          cmake --build build-benchmark --target LiborSwaptionPricerJIT

      # --- Baseline build steps (only for baseline build_type) ---
      - name: Build LiborSwaptionPricer (Baseline)
        if: matrix.build_type == 'baseline'
        run: |
          cd xad
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DXAD_ENABLE_TESTS=ON
          cmake --build build --target LiborSwaptionPricer

      # --- Run benchmarks ---
      - name: Run Benchmark (Forge)
        if: matrix.build_type == 'forge'
        run: |
          export LD_LIBRARY_PATH=$(pwd)/install/lib:$LD_LIBRARY_PATH
          ./xad/build-benchmark/samples/LiborSwaptionPricer/JIT/LiborSwaptionPricerJIT

      - name: Run Benchmark (Baseline)
        if: matrix.build_type == 'baseline'
        run: |
          ./xad/build/samples/LiborSwaptionPricer/LiborSwaptionPricer

  ##############################################################################
  # Windows Benchmark
  ##############################################################################
  windows:
    name: Windows ${{ matrix.build_type }}
    runs-on: windows-2022

    strategy:
      fail-fast: false
      matrix:
        build_type:
          - baseline
          - forge
        exclude:
          - build_type: ${{ github.event.inputs.build_type == 'baseline' && 'forge' || '' }}
          - build_type: ${{ github.event.inputs.build_type == 'forge' && 'baseline' || '' }}

    env:
      VSVARSALL: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat

    steps:
      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          path: xad

      - name: Checkout Forge
        if: matrix.build_type == 'forge'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORGE_REPO }}
          ref: ${{ env.FORGE_BRANCH }}
          path: forge

      - name: Checkout xad-forge
        if: matrix.build_type == 'forge'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_FORGE_REPO }}
          ref: ${{ env.XAD_FORGE_BRANCH }}
          path: xad-forge

      - name: Setup
        run: choco install -y ninja

      # --- Forge build steps (only for forge build_type) ---
      - name: Build Forge C API
        if: matrix.build_type == 'forge'
        shell: cmd
        run: |
          cd forge
          call "%VSVARSALL%" amd64
          cmake -B build -S api/c -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DFORGE_CAPI_BUILD_TESTS=OFF ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build
          cmake --install build

      - name: Build XAD (with JIT)
        if: matrix.build_type == 'forge'
        shell: cmd
        run: |
          cd xad
          call "%VSVARSALL%" amd64
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_STANDARD=17 ^
            -DXAD_ENABLE_JIT=ON ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build
          cmake --install build

      - name: Build xad-forge
        if: matrix.build_type == 'forge'
        shell: cmd
        run: |
          cd xad-forge
          call "%VSVARSALL%" amd64
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_STANDARD=17 ^
            -DCMAKE_PREFIX_PATH="%cd%\..\install" ^
            -DXAD_FORGE_USE_CAPI=ON ^
            -DXAD_FORGE_BUILD_TESTS=OFF ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build
          cmake --install build

      - name: Build LiborSwaptionPricerJIT (Forge)
        if: matrix.build_type == 'forge'
        shell: cmd
        run: |
          cd xad
          call "%VSVARSALL%" amd64
          cmake -B build-benchmark -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_STANDARD=17 ^
            -DXAD_ENABLE_JIT=ON ^
            -DXAD_ENABLE_TESTS=ON ^
            -DCMAKE_PREFIX_PATH="%cd%\..\install"
          cmake --build build-benchmark --target LiborSwaptionPricerJIT

      # --- Baseline build steps (only for baseline build_type) ---
      - name: Build LiborSwaptionPricer (Baseline)
        if: matrix.build_type == 'baseline'
        shell: cmd
        run: |
          cd xad
          call "%VSVARSALL%" amd64
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_STANDARD=17 ^
            -DXAD_ENABLE_TESTS=ON
          cmake --build build --target LiborSwaptionPricer

      # --- Run benchmarks ---
      - name: Run Benchmark (Forge)
        if: matrix.build_type == 'forge'
        shell: cmd
        run: |
          set PATH=%cd%\install\bin;%PATH%
          xad\build-benchmark\samples\LiborSwaptionPricer\JIT\LiborSwaptionPricerJIT.exe

      - name: Run Benchmark (Baseline)
        if: matrix.build_type == 'baseline'
        shell: cmd
        run: |
          xad\build\samples\LiborSwaptionPricer\LiborSwaptionPricer.exe
